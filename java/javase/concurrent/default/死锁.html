<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>死锁 | 刘新冬的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/img/logo.png">
    <meta name="description" content="死锁">
    
    <link rel="preload" href="/blog/assets/css/0.styles.ef7b091d.css" as="style"><link rel="preload" href="/blog/assets/js/app.beefb89b.js" as="script"><link rel="preload" href="/blog/assets/js/2.ba6b1436.js" as="script"><link rel="preload" href="/blog/assets/js/1.2d4ce02f.js" as="script"><link rel="preload" href="/blog/assets/js/92.25c79477.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.14082ad8.js"><link rel="prefetch" href="/blog/assets/js/100.3fe3bc9e.js"><link rel="prefetch" href="/blog/assets/js/101.7548bc20.js"><link rel="prefetch" href="/blog/assets/js/102.f5b300a6.js"><link rel="prefetch" href="/blog/assets/js/103.26326f12.js"><link rel="prefetch" href="/blog/assets/js/104.fbc208c4.js"><link rel="prefetch" href="/blog/assets/js/105.d0a06cee.js"><link rel="prefetch" href="/blog/assets/js/106.5648862e.js"><link rel="prefetch" href="/blog/assets/js/107.7d7c4a8e.js"><link rel="prefetch" href="/blog/assets/js/108.8d688a75.js"><link rel="prefetch" href="/blog/assets/js/109.8fd97deb.js"><link rel="prefetch" href="/blog/assets/js/11.d36ef131.js"><link rel="prefetch" href="/blog/assets/js/110.7e26022e.js"><link rel="prefetch" href="/blog/assets/js/111.73395e1c.js"><link rel="prefetch" href="/blog/assets/js/12.c5493e01.js"><link rel="prefetch" href="/blog/assets/js/13.430eca0c.js"><link rel="prefetch" href="/blog/assets/js/14.c88f86cd.js"><link rel="prefetch" href="/blog/assets/js/15.e1cc950a.js"><link rel="prefetch" href="/blog/assets/js/16.b699b95c.js"><link rel="prefetch" href="/blog/assets/js/17.b99ba729.js"><link rel="prefetch" href="/blog/assets/js/18.7dff4b06.js"><link rel="prefetch" href="/blog/assets/js/19.ff06d982.js"><link rel="prefetch" href="/blog/assets/js/20.7de9995c.js"><link rel="prefetch" href="/blog/assets/js/21.cb9bdcf0.js"><link rel="prefetch" href="/blog/assets/js/22.16dfd536.js"><link rel="prefetch" href="/blog/assets/js/23.eb560dbc.js"><link rel="prefetch" href="/blog/assets/js/24.8f1cc4bb.js"><link rel="prefetch" href="/blog/assets/js/25.c7f21645.js"><link rel="prefetch" href="/blog/assets/js/26.01505d95.js"><link rel="prefetch" href="/blog/assets/js/27.cb93dd1f.js"><link rel="prefetch" href="/blog/assets/js/28.f119234c.js"><link rel="prefetch" href="/blog/assets/js/29.4ebed3b0.js"><link rel="prefetch" href="/blog/assets/js/3.00356991.js"><link rel="prefetch" href="/blog/assets/js/30.1764139a.js"><link rel="prefetch" href="/blog/assets/js/31.fe5fff12.js"><link rel="prefetch" href="/blog/assets/js/32.d97feb3b.js"><link rel="prefetch" href="/blog/assets/js/33.28ff3136.js"><link rel="prefetch" href="/blog/assets/js/34.24566881.js"><link rel="prefetch" href="/blog/assets/js/35.2aadf9ad.js"><link rel="prefetch" href="/blog/assets/js/36.3a5bd736.js"><link rel="prefetch" href="/blog/assets/js/37.fcbade32.js"><link rel="prefetch" href="/blog/assets/js/38.d17979ce.js"><link rel="prefetch" href="/blog/assets/js/39.e653bd2d.js"><link rel="prefetch" href="/blog/assets/js/4.7fa5c39e.js"><link rel="prefetch" href="/blog/assets/js/40.b0c0ed76.js"><link rel="prefetch" href="/blog/assets/js/41.fc9f747a.js"><link rel="prefetch" href="/blog/assets/js/42.1b630c60.js"><link rel="prefetch" href="/blog/assets/js/43.53183817.js"><link rel="prefetch" href="/blog/assets/js/44.ba0e6346.js"><link rel="prefetch" href="/blog/assets/js/45.05d8c3dc.js"><link rel="prefetch" href="/blog/assets/js/46.4d50f591.js"><link rel="prefetch" href="/blog/assets/js/47.a769691a.js"><link rel="prefetch" href="/blog/assets/js/48.0e49b5c3.js"><link rel="prefetch" href="/blog/assets/js/49.2c4b0b01.js"><link rel="prefetch" href="/blog/assets/js/5.8a935be6.js"><link rel="prefetch" href="/blog/assets/js/50.584c1d09.js"><link rel="prefetch" href="/blog/assets/js/51.9a3f5dad.js"><link rel="prefetch" href="/blog/assets/js/52.b6ae0713.js"><link rel="prefetch" href="/blog/assets/js/53.046b88a2.js"><link rel="prefetch" href="/blog/assets/js/54.a9b9bb45.js"><link rel="prefetch" href="/blog/assets/js/55.2228af6c.js"><link rel="prefetch" href="/blog/assets/js/56.520cefb5.js"><link rel="prefetch" href="/blog/assets/js/57.288da8cb.js"><link rel="prefetch" href="/blog/assets/js/58.55e4261f.js"><link rel="prefetch" href="/blog/assets/js/59.ec68709d.js"><link rel="prefetch" href="/blog/assets/js/6.c6745fa4.js"><link rel="prefetch" href="/blog/assets/js/60.9e00e022.js"><link rel="prefetch" href="/blog/assets/js/61.af320179.js"><link rel="prefetch" href="/blog/assets/js/62.fec720d6.js"><link rel="prefetch" href="/blog/assets/js/63.34fd5f71.js"><link rel="prefetch" href="/blog/assets/js/64.08909954.js"><link rel="prefetch" href="/blog/assets/js/65.c5c5f29e.js"><link rel="prefetch" href="/blog/assets/js/66.1f2fccf4.js"><link rel="prefetch" href="/blog/assets/js/67.2b73166f.js"><link rel="prefetch" href="/blog/assets/js/68.b4beef25.js"><link rel="prefetch" href="/blog/assets/js/69.0003ce16.js"><link rel="prefetch" href="/blog/assets/js/7.f127ebf8.js"><link rel="prefetch" href="/blog/assets/js/70.dc4a33ea.js"><link rel="prefetch" href="/blog/assets/js/71.133e5d42.js"><link rel="prefetch" href="/blog/assets/js/72.cf6be888.js"><link rel="prefetch" href="/blog/assets/js/73.54db959f.js"><link rel="prefetch" href="/blog/assets/js/74.e4a072d4.js"><link rel="prefetch" href="/blog/assets/js/75.69e2338b.js"><link rel="prefetch" href="/blog/assets/js/76.bd566a9e.js"><link rel="prefetch" href="/blog/assets/js/77.6f4860be.js"><link rel="prefetch" href="/blog/assets/js/78.31043a7f.js"><link rel="prefetch" href="/blog/assets/js/79.5775dfc4.js"><link rel="prefetch" href="/blog/assets/js/80.aed400b3.js"><link rel="prefetch" href="/blog/assets/js/81.d1b37fde.js"><link rel="prefetch" href="/blog/assets/js/82.c931d220.js"><link rel="prefetch" href="/blog/assets/js/83.c657ef8e.js"><link rel="prefetch" href="/blog/assets/js/84.5b2501ff.js"><link rel="prefetch" href="/blog/assets/js/85.52de2b85.js"><link rel="prefetch" href="/blog/assets/js/86.70c7c9e2.js"><link rel="prefetch" href="/blog/assets/js/87.cfb10280.js"><link rel="prefetch" href="/blog/assets/js/88.1f0b6531.js"><link rel="prefetch" href="/blog/assets/js/89.0fe143c2.js"><link rel="prefetch" href="/blog/assets/js/90.e658e2b0.js"><link rel="prefetch" href="/blog/assets/js/91.f53450dd.js"><link rel="prefetch" href="/blog/assets/js/93.044e8f4d.js"><link rel="prefetch" href="/blog/assets/js/94.b316928c.js"><link rel="prefetch" href="/blog/assets/js/95.2a709d19.js"><link rel="prefetch" href="/blog/assets/js/96.886e0cc2.js"><link rel="prefetch" href="/blog/assets/js/97.e9923d97.js"><link rel="prefetch" href="/blog/assets/js/98.88a3dab6.js"><link rel="prefetch" href="/blog/assets/js/99.83aab1e2.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.162bdabc.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.ef7b091d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="刘新冬的博客" class="logo"> <span class="site-name can-hide">刘新冬的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaSE</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/javase/" aria-current="page" class="sidebar-link">简介</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>集合</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/javase/collection/default/Collection.html" class="sidebar-link">Collection</a></li><li><a href="/blog/java/javase/collection/default/List.html" class="sidebar-link">List</a></li><li><a href="/blog/java/javase/collection/default/Map.html" class="sidebar-link">Map</a></li><li><a href="/blog/java/javase/collection/default/Queue.html" class="sidebar-link">Queue</a></li><li><a href="/blog/java/javase/collection/default/Set.html" class="sidebar-link">Set</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/javase/concurrent/default/设计线程安全的类.html" class="sidebar-link">设计线程安全的类</a></li><li><a href="/blog/java/javase/concurrent/default/基础构建模块.html" class="sidebar-link">基础构建模块</a></li><li><a href="/blog/java/javase/concurrent/default/任务执行.html" class="sidebar-link">任务执行</a></li><li><a href="/blog/java/javase/concurrent/default/取消与关闭.html" class="sidebar-link">取消与关闭</a></li><li><a href="/blog/java/javase/concurrent/default/线程池的使用.html" class="sidebar-link">线程池的使用</a></li><li><a href="/blog/java/javase/concurrent/default/死锁.html" class="active sidebar-link">死锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_1-死锁" class="sidebar-link">1. 死锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_1-1-锁顺序死锁" class="sidebar-link">1.1 锁顺序死锁</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_1-2-动态的锁顺序死锁" class="sidebar-link">1.2 动态的锁顺序死锁</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_1-3-在协作对象之间发生的死锁" class="sidebar-link">1.3 在协作对象之间发生的死锁</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_1-4-开放调用" class="sidebar-link">1.4 开放调用</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_1-5-资源死锁" class="sidebar-link">1.5 资源死锁</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_2-死锁的避免与诊断" class="sidebar-link">2. 死锁的避免与诊断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_2-1-避免" class="sidebar-link">2.1 避免</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_2-2-诊断" class="sidebar-link">2.2 诊断</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_3-其他活跃性危险" class="sidebar-link">3. 其他活跃性危险</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_3-1-饥饿" class="sidebar-link">3.1 饥饿</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_3-2-糟糕的响应性" class="sidebar-link">3.2 糟糕的响应性</a></li><li class="sidebar-sub-header"><a href="/blog/java/javase/concurrent/default/死锁.html#_3-3-活锁" class="sidebar-link">3.3 活锁</a></li></ul></li></ul></li><li><a href="/blog/java/javase/concurrent/default/性能与可伸缩性.html" class="sidebar-link">性能与可伸缩性</a></li><li><a href="/blog/java/javase/concurrent/default/显式锁.html" class="sidebar-link">显式锁</a></li><li><a href="/blog/java/javase/concurrent/default/构建自定义的同步工具.html" class="sidebar-link">构建自定义的同步工具</a></li><li><a href="/blog/java/javase/concurrent/default/原子变量与非阻塞同步机制.html" class="sidebar-link">原子变量与非阻塞同步机制</a></li><li><a href="/blog/java/javase/concurrent/default/Executor框架.html" class="sidebar-link">Executor框架</a></li><li><a href="/blog/java/javase/concurrent/default/Future框架.html" class="sidebar-link">Future框架</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/javase/other/default/static关键字.html" class="sidebar-link">static关键字</a></li><li><a href="/blog/java/javase/other/default/泛型机制.html" class="sidebar-link">泛型机制</a></li><li><a href="/blog/java/javase/other/default/解决hash冲突的常用方法.html" class="sidebar-link">解决hash冲突的常用方法</a></li><li><a href="/blog/java/javase/other/default/三元运算符与类型转换.html" class="sidebar-link">三元运算符与类型转换</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/javase/io/default/NIO概述.html" class="sidebar-link">NIO概述</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-死锁"><a href="#_1-死锁" class="header-anchor">#</a> 1. 死锁</h2> <h3 id="_1-1-锁顺序死锁"><a href="#_1-1-锁顺序死锁" class="header-anchor">#</a> 1.1 锁顺序死锁</h3> <p>如果所有线程以固定的顺序来获得锁，那么在程序中就不会出现锁顺序死锁问题.</p> <div class="language- extra-class"><pre class="language-text"><code>****** 程序清单10-1 简单的锁顺序死锁 ******

public class LeftRightDeadLock{
    private final Object left =  new Object();
    private final Object right =  new Object();
    
    public void leftRight(){
        synchronized (left){
            synchronized (right){
                doSomething();
            }
        }
    }

    public void rightLeft(){
        synchronized (right){
            synchronized (left){
                doSomethingElse();
            }
        }
    }
}
</code></pre></div><h3 id="_1-2-动态的锁顺序死锁"><a href="#_1-2-动态的锁顺序死锁" class="header-anchor">#</a> 1.2 动态的锁顺序死锁</h3> <div class="language- extra-class"><pre class="language-text"><code>****** 程序清单10-2 动态的锁顺序死锁 ******

public void transferMoney(Account fromAccount,Account toAccount,DollarAmount amount){
    synchronized (fromAccount){
        synchronized (toAccount){
            if(fromAccount.getMoney().compareTo(amount)&lt;0){
                throw new RuntimeException();
            }else{
                fromAccount.debit(amount);
                toAccount.credit(amount);
            }
            
        }
    }
}
</code></pre></div><p>程序清单10-2模拟了银行转账的逻辑，初步看起来，貌似不会有死锁的问题，但是该代码依然会出现死锁问题，那就是当A向B转账的同时，另一个线程中B向A转账，便会发生死锁。</p> <p>在指定锁的顺序时，可以使用<code>System.identifyHashCode</code>方法，该方法将返回由<code>Object.hashCode</code>返回的值。</p> <div class="language- extra-class"><pre class="language-text"><code>****** 程序清单10-3 通过锁顺序来避免死锁 ******

private static final Object tieLock = new Object();

public void transferMoney(Account fromAccount,Account toAccount,DollarAmount amount){
    class Helper{
        public void transfer(){
            if(fromAccount.getMoney().compareTo(amount)&lt;0){
                throw new RuntimeException();
            }else{
                fromAccount.debit(amount);
                toAccount.credit(amount);
            }
        }
    }
    
    int fromHash = System.identityHashCode(fromAccount);
    int toHash = System.identityHashCode(toAccount);
    
    if(fromAccount &lt; toAccount){
        synchronized (fromAccount){
            synchronized (toAccount){
                new Helper().transfer();
            }
        }
    }else if(fromAccount &gt; toAccount){
        synchronized (toAccount){
            synchronized (fromAccount){
                new Helper().transfer();
            }
        }
    }else{
        synchronized (tieLock){
            synchronized (fromAccount){
                synchronized (toAccount){
                    new Helper().transfer();
                }
            }
        }
    }
}
</code></pre></div><p>在极少数情况下，两个对象可能拥有相同的散列值，此时必须通过某种任意的方法来决定锁的顺序，而这可能又会重新引入死锁。为了避免这种情况，可以使用”加时赛”锁，在获取Account两个锁之前，首先获得这个”加时赛”锁，从而保证每次只有一个线程以未知的顺序获得这两个锁，从而消除了死锁发生的可能性。</p> <div class="language- extra-class"><pre class="language-text"><code>** 程序清单10-4 在典型条件下会发生死锁的循环 **

public class DemonstrateDeadlock{
    private static final int NUM_THREADS = 20;
    private static final int NUM_ACCOUNTS = 20;
    private static final int NUM_ITERATIONS = 20;

    public static void main(String[] args) {
        final Random random = new Random();
        final Account[] accounts = new Account[NUM_ACCOUNTS];
        
        for(int i=0;i&lt;accounts.length;i++){
            accounts[i] = new Account();
        }
        
        class TransferThread extends Thread{
            @Override
            public void run() {
                for(int i=0;i&lt;NUM_ITERATIONS;i++){
                    int fromAccount = random.nextInt(NUM_ACCOUNTS);
                    int toAccount = random.nextInt(NUM_ACCOUNTS);
                    DollarAmount amount = new DollarAmount(random.nextInt(1000));
                    transferMoney(accounts[fromAccount],accounts[toAccount],amount);
                }
            }
        }
        
        for(int i=0;i&lt;NUM_THREADS;i++){
            new TransferThread().start();
        }
    }
}
</code></pre></div><h3 id="_1-3-在协作对象之间发生的死锁"><a href="#_1-3-在协作对象之间发生的死锁" class="header-anchor">#</a> 1.3 在协作对象之间发生的死锁</h3> <div class="language- extra-class"><pre class="language-text"><code>****** 程序清单10-5 在相互协作的对象之间的锁顺序死锁 ******

class Taxi{
    @GuardeBy(&quot;this&quot;)
    private Point location,destination;
    private final Dispatcher dispatcher;
    
    public Taxi(Dispatcher dispatcher){
        this.dispatcher = dispatcher;
    }
    
    public synchronized Point getLocation(){
        return location;
    }
    
    public synchronized void setLocation(Point location){
        this.location = location;
        if(location.equals(destination)){
            dispatcher.notifyAvailable(this);
        }
    }
}

class Dispatcher{
    @GuardeBy(&quot;this&quot;)
    private final Set&lt;Taxi&gt; taxis;
    @GuardeBy(&quot;this&quot;)
    private final Set&lt;Taxi&gt; availableTaxis;
    
    public Dispatcher(){
        taxis = new HashSet&lt;&gt;();
        availableTaxis = new HashSet&lt;&gt;();
    }
    
    public synchronized void notifyAvailable(Taxi taxi){
        availableTaxis.add(taxi);
    }
    
    public synchronized Image getImage(){
        Image image = new Image();
        for(Taxi t:taxis){
            image.drawMarker(t.getLocation());
        }
        return image;
    }
}
</code></pre></div><p>尽管没有任何方法会显式地获取两个数，但<code>setLocation</code>和<code>getImage</code>等方法的调用者都会获得两个锁。如果一个线程在收到GPS接收器的更新事件时调用<code>setLocation</code>，那么它将首先更新出租车的位置，然后判断出它是否到达了目的地。如果已经到达，它会通知Dispatcher需要一个新的目的地。因为<code>setLocation</code>和<code>notifyAvailable</code>都是同步方法，因此调用<code>setLocation</code>的线程将首先获取Taxi的锁，然后获取Dispatcher的锁。同样，调用<code>getImage</code>的线程将首先获取Dispatcher的锁，然后再获取每一个Taxi的锁。这与LeftRightDeadLock中的情况相同，两个线程按照不同的顺序来获取两个锁，因此就可能产生死锁。</p> <h3 id="_1-4-开放调用"><a href="#_1-4-开放调用" class="header-anchor">#</a> 1.4 开放调用</h3> <p>如果在调用某个方法时不需要持有锁，那么这种调用被称为开放调用。</p> <div class="language- extra-class"><pre class="language-text"><code>****** 程序清单10-6 通过公开调用来避免在相互协作的对象之间产生死锁 ******

class Taxi{
    @GuardeBy(&quot;this&quot;)
    private Point location,destination;
    private final Dispatcher dispatcher;

    public Taxi(Dispatcher dispatcher){
        this.dispatcher = dispatcher;
    }

    public synchronized Point getLocation(){
        return location;
    }

    public void setLocation(Point location){
        boolean reachedDestination;
        synchronized (this){
            this.location = location;
            reachedDestination = location.equals(destination);
        }
        if(reachedDestination){
            dispatcher.notifyAvailable(this);
        }
    }
}

class Dispatcher{
    @GuardeBy(&quot;this&quot;)
    private final Set&lt;Taxi&gt; taxis;
    @GuardeBy(&quot;this&quot;)
    private final Set&lt;Taxi&gt; availableTaxis;

    public Dispatcher(){
        taxis = new HashSet&lt;&gt;();
        availableTaxis = new HashSet&lt;&gt;();
    }

    public synchronized void notifyAvailable(Taxi taxi){
        availableTaxis.add(taxi);
    }

    public Image getImage(){
        Set&lt;Taxi&gt; copy;
        synchronized (this){
            copy = new HashSet&lt;&gt;(taxis);
        }
        Image image = new Image();
        for(Taxi t:copy){
            image.drawMarker(t.getLocation());
        }
        return image;
    }
}
</code></pre></div><h3 id="_1-5-资源死锁"><a href="#_1-5-资源死锁" class="header-anchor">#</a> 1.5 资源死锁</h3> <p>当多个线程相互持有彼此正在等待的锁而又不释放自己已持有的锁时会发生死锁，当它们在相同的资源集合上等待时,也会发生死锁。</p> <p>有界线程池/资源池与相互依赖的任务不能一起使用。</p> <h2 id="_2-死锁的避免与诊断"><a href="#_2-死锁的避免与诊断" class="header-anchor">#</a> 2. 死锁的避免与诊断</h2> <h3 id="_2-1-避免"><a href="#_2-1-避免" class="header-anchor">#</a> 2.1 避免</h3> <ol><li>确保多个线程获取锁的顺序都保持一致。</li> <li>尽可能使用开放调用。</li> <li>显式使用Lock类中的定时tryLock功能。</li></ol> <h3 id="_2-2-诊断"><a href="#_2-2-诊断" class="header-anchor">#</a> 2.2 诊断</h3> <p>可以通过线程转储信息来分析死锁。</p> <h2 id="_3-其他活跃性危险"><a href="#_3-其他活跃性危险" class="header-anchor">#</a> 3. 其他活跃性危险</h2> <h3 id="_3-1-饥饿"><a href="#_3-1-饥饿" class="header-anchor">#</a> 3.1 饥饿</h3> <p>在Thread API中定义的线程优先级只是作为线程调度的参考。</p> <p>在Thread API中定义了10个优先级，JVM根据需要将它们映射到操作系统的调度优先级。这种映射是与特定平台相关的。</p> <p><strong>要避免使用线程优先级</strong>，因为这会增加平台依赖性，并可能导致活跃性问题。在大多数并发应用程序中，都可以使用默认的线程优先级。</p> <h3 id="_3-2-糟糕的响应性"><a href="#_3-2-糟糕的响应性" class="header-anchor">#</a> 3.2 糟糕的响应性</h3> <h3 id="_3-3-活锁"><a href="#_3-3-活锁" class="header-anchor">#</a> 3.3 活锁</h3> <p>活锁不会阻塞线程，但也不能继续执行，因为线程将不断重复执行相同的操作，而且总会失败。</p> <p>当多个相互协作的线程都对彼此进行响应从而修改各自的状态，并使得任何一个线程都无法继续执行时，就发生了活锁。</p> <p>在并发应用程序中，通过等待随机长度的时间和回退可以有效地避免活锁的发生。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/java/javase/concurrent/default/线程池的使用.html" class="prev">
        线程池的使用
      </a></span> <span class="next"><a href="/blog/java/javase/concurrent/default/性能与可伸缩性.html">
        性能与可伸缩性
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.beefb89b.js" defer></script><script src="/blog/assets/js/2.ba6b1436.js" defer></script><script src="/blog/assets/js/1.2d4ce02f.js" defer></script><script src="/blog/assets/js/92.25c79477.js" defer></script>
  </body>
</html>
